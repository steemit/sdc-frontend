limit_req_zone $http_x_forwarded_for zone=sdc:32m rate=100r/m;
proxy_cache_path /var/cache/nginx levels=1:2 inactive=6h keys_zone=sdc_cache:100m;

server {

    listen 8081;
    server_name $SERVER_NAME;

    # ddos blacklist
    deny 43.255.142.87;
    deny 41.109.234.199;
    deny 105.98.63.176;
    deny 212.28.80.170;
    deny 171.49.131.210;
    deny 201.11.220.176;
    deny 106.203.67.60;
    deny 77.121.177.16;
    deny 41.141.182.111;
    deny 178.149.74.37;
    deny 120.29.66.143;
    deny 103.197.134.253;
    deny 80.242.3.93;
    deny 27.34.20.192;
    deny 185.32.23.2;
    deny 181.66.10.15;
    deny 112.133.248.21;
    deny 31.11.129.64;
    deny 88.23.206.197;
    deny 213.135.163.116;
    deny 124.124.21.33;
    deny 95.10.207.93;
    deny 178.221.6.209;
    deny 47.29.67.145;
    deny 185.57.68.66;
    deny 202.51.93.20;
    deny 79.119.210.62;
    deny 180.241.13.6;
    deny 112.198.118.105;
    deny 93.87.174.95;
    deny 77.123.23.67;
    deny 79.179.122.204;
    deny 89.40.204.153;
    deny 197.2.230.196;
    deny 93.138.121.54;
    deny 188.236.24.247;
    deny 93.51.158.100;
    deny 82.78.242.229;
    deny 172.103.1.51;
    deny 45.251.32.175;
    deny 91.140.88.147;
    deny 42.119.233.109;
    deny 103.72.218.160;
    deny 197.0.59.95;
    deny 122.162.9.5;
    deny 118.71.19.160;
    deny 194.228.68.229;
    deny 94.176.160.143;
    deny 87.165.12.73;
    deny 93.159.195.169;
    deny 178.150.93.135;
    deny 82.208.215.31;
    deny 89.123.127.200;
    deny 176.63.25.92;
    deny 43.250.165.49;
    deny 79.113.7.84;
    deny 177.83.205.221;
    deny 86.124.95.169;
    deny 42.113.188.168;
    deny 92.81.205.173;
    deny 213.233.93.5;
    deny 101.78.236.209;
    deny 176.63.21.77;
    deny 95.42.90.17;
    deny 41.108.21.214;
    deny 37.210.134.209;
    deny 37.210.136.74;
    deny 41.46.143.101;
    deny 154.121.251.88;
    deny 91.83.192.157;
    deny 89.42.28.252;
    deny 111.125.209.113;
    deny 186.194.64.62;
    deny 178.254.163.117;
    deny 213.135.175.242;
    deny 202.190.135.132;
    deny 79.226.88.64;
    deny 182.253.163.67;
    deny 106.201.84.76;
    deny 61.2.46.139;
    deny 87.203.204.65;
    deny 111.125.108.178;
    deny 171.60.193.179;
    deny 217.219.90.98;
    deny 139.228.161.124;
    deny 39.54.1.125;
    deny 106.51.209.10;
    deny 139.0.119.236;
    deny 49.0.133.21;
    deny 90.231.92.109;
    deny 180.254.32.191;
    deny 103.255.5.85;
    deny 54.194.149.110;
    deny 96.30.88.133;
    deny 62.210.178.135;
    deny 103.73.153.69;
    deny 178.59.215.54;
    deny 176.58.99.134;
    deny 195.154.162.66;
    deny 134.213.156.62;
    deny 68.150.126.250;
    deny 27.78.20.134;
    deny 213.186.202.190;
    deny 119.24.124.55;
    deny 37.116.71.12;
    deny 54.204.35.192;
    deny 122.164.176.76;
    deny 78.29.26.50;
    deny 37.135.146.75;
    deny 187.149.33.36;
    deny 195.66.242.14;
    deny 72.251.248.20;
    deny 188.26.93.212;
    deny 94.156.195.106;
    deny 104.155.83.50;
    deny 79.99.1.150;
    deny 14.177.209.138;
    deny 157.50.12.34;
    deny 27.5.24.243;
    deny 162.243.71.43;
    deny 164.100.180.244;
    deny 120.188.4.200;
    deny 112.133.251.102;
    deny 54.225.196.191;
    deny 181.188.19.143;
    deny 206.188.12.149;
    deny 82.166.80.231;
    deny 45.55.138.16;
    deny 91.146.132.232;
    deny 124.107.71.171;
    deny 103.58.92.58;
    deny 91.245.98.157;
    deny 104.236.108.111;
    deny 103.213.129.113;
    deny 198.58.111.242;
    deny 83.251.228.137;
    deny 49.151.122.23;
    deny 79.130.248.213;
    deny 110.36.177.36;
    deny 119.94.98.243;
    deny 54.225.108.17;
    deny 46.10.236.113;
    deny 47.31.2.5;
    deny 50.57.114.79;
    deny 91.222.48.182;
    deny 180.243.115.66;
    deny 85.186.66.36;
    deny 110.136.110.227;
    deny 104.208.158.205;
    deny 88.150.232.122;
    deny 103.85.241.34;
    deny 104.154.51.220;
    deny 180.249.115.192;
    deny 178.221.201.12;
    deny 176.41.191.218;
    deny 124.104.245.48;
    deny 134.35.246.64;
    deny 193.92.71.195;
    deny 223.190.64.176;
    deny 192.1.122.24;
    deny 115.70.137.92;
    deny 107.191.48.203;
    deny 124.158.109.223;
    deny 176.9.198.123;
    deny 45.55.153.12;
    deny 110.36.231.27;
    deny 41.253.84.212;
    deny 113.255.113.90;
    deny 157.48.11.0;
    deny 203.201.220.221;
    deny 188.226.253.244;
    deny 142.58.106.105;
    deny 45.55.136.8;
    deny 112.202.98.50;
    deny 90.101.250.100;
    deny 104.131.1.54;
    deny 27.121.103.182;
    deny 115.87.153.33;
    deny 80.90.48.200;
    deny 173.203.64.225;
    deny 93.39.138.48;
    deny 36.78.86.210;
    deny 54.197.188.247;
    deny 166.78.191.165;
    deny 212.48.74.75;
    deny 52.3.78.68;
    deny 183.182.103.28;
    deny 61.6.146.132;
    deny 52.88.131.45;
    deny 77.138.128.9;
    deny 115.73.61.141;
    deny 66.228.52.70;
    deny 111.93.51.154;
    deny 5.57.73.37;
    deny 199.233.242.2;
    deny 124.83.100.7;
    deny 95.87.23.17;
    deny 122.171.103.206;
    deny 52.21.93.168;
    deny 170.246.215.103;
    deny 41.144.13.135;
    deny 52.91.249.153;
    deny 180.253.100.194;
    deny 46.101.25.115;
    deny 116.90.113.62;
    deny 125.161.83.122;
    deny 54.153.81.88;
    deny 162.242.156.239;
    deny 117.195.112.38;
    deny 112.215.239.246;
    deny 14.139.45.242;
    deny 103.82.210.159;
    deny 52.33.102.93;
    deny 103.247.217.242;
    deny 92.86.36.248;
    deny 49.244.168.252;
    deny 36.72.18.75;
    deny 173.227.253.179;
    deny 45.55.153.218;
    deny 95.85.23.119;
    deny 118.137.235.130;
    deny 104.130.105.108;
    deny 62.210.192.91;
    deny 62.121.81.248;
    deny 216.248.194.20;
    deny 23.92.29.238;
    deny 104.43.166.217;
    deny 182.75.230.202;
    deny 92.81.198.180;
    deny 196.219.83.144;
    deny 50.57.170.16;
    deny 182.179.155.155;
    deny 79.106.209.150;
    deny 86.193.99.206;
    deny 109.238.224.182;
    deny 80.248.227.35;
    deny 125.25.81.231;
    deny 203.138.99.74;
    deny 191.205.189.20;
    deny 93.113.116.3;
    deny 122.163.196.171;
    deny 39.33.149.124;
    deny 104.239.139.80;
    deny 188.236.62.145;
    deny 70.32.87.66;
    deny 137.117.145.49;
    deny 117.200.104.251;
    deny 205.186.149.214;
    deny 117.20.56.114;
    deny 70.183.45.107;
    deny 107.170.241.24;
    deny 79.118.97.95;
    deny 112.198.72.70;
    deny 107.21.117.242;
    deny 193.248.198.67;
    deny 90.224.102.205;
    deny 176.63.21.18;
    deny 117.248.177.219;
    deny 201.9.126.153;
    deny 185.56.86.124;
    deny 192.237.188.71;
    deny 78.97.15.74;
    deny 130.211.158.77;
    deny 103.78.221.146;
    deny 41.232.6.24;
    deny 112.200.5.48;
    deny 178.62.23.217;
    deny 146.196.45.253;
    deny 124.120.104.52;
    deny 2.184.238.170;
    deny 203.76.178.97;
    deny 176.58.88.229;
    deny 24.142.232.11;
    deny 151.247.2.237;
    deny 203.29.27.150;
    deny 50.56.182.44;
    deny 117.218.201.217;
    deny 49.144.224.234;
    deny 75.151.86.237;
    deny 180.190.182.232;
    deny 41.227.188.20;
    deny 52.4.100.161;
    deny 87.243.98.31;
    deny 91.121.177.197;
    deny 80.248.227.75;
    deny 61.94.245.69;
    deny 41.46.179.123;
    deny 42.112.138.89;
    deny 54.148.28.207;
    deny 37.252.67.65;
    deny 47.8.14.47;
    deny 180.245.184.118;
    deny 151.247.39.166;
    deny 185.8.158.5;
    deny 1.236.29.177;
    deny 171.6.240.251;
    deny 144.48.50.237;
    deny 198.58.100.216;
    deny 1.186.251.234;
    deny 45.249.170.85;
    deny 141.101.252.254;
    deny 52.88.38.17;
    deny 185.117.8.89;
    deny 117.215.60.107;
    deny 54.82.99.47;
    deny 1.186.37.159;
    deny 39.60.62.43;
    deny 92.84.103.220;
    deny 93.87.243.120;
    deny 105.67.3.88;
    deny 109.92.44.67;
    deny 104.155.59.253;
    deny 198.199.114.171;
    deny 116.109.223.189;
    deny 91.202.16.2;
    deny 173.233.90.82;
    deny 177.128.70.2;
    deny 185.35.186.101;
    deny 103.62.16.2;
    deny 122.174.49.227;
    deny 23.253.89.185;
    deny 201.157.222.62;
    deny 178.79.131.201;
    deny 123.1.44.20;
    deny 189.5.231.99;
    deny 81.196.202.149;
    deny 43.254.125.7;
    deny 103.57.123.226;
    deny 113.193.178.68;
    deny 103.255.234.253;
    deny 112.203.173.156;
    deny 54.225.224.158;
    deny 182.185.53.225;
    deny 5.174.52.107;
    deny 54.226.53.196;
    deny 104.236.171.89;
    deny 36.72.196.112;
    deny 210.72.68.237;
    deny 42.109.91.218;
    deny 182.70.20.117;
    deny 187.54.236.242;
    deny 52.32.189.224;
    deny 200.6.123.175;
    deny 59.96.244.33;
    deny 104.40.62.163;
    deny 5.15.242.144;
    deny 54.236.196.7;
    deny 191.223.89.254;
    deny 190.144.15.90;
    deny 175.100.60.212;
    deny 151.248.0.215;
    deny 5.14.175.245;
    deny 117.253.203.246;
    deny 59.89.183.155;
    deny 151.248.0.150;
    deny 54.84.158.77;
    deny 178.62.25.66;
    deny 77.64.157.100;
    deny 52.1.92.241;
    deny 117.222.255.3;
    deny 31.167.43.20;
    deny 190.73.121.220;
    deny 103.248.211.186;
    deny 196.217.156.93;
    deny 112.205.31.117;
    deny 106.193.255.196;
    deny 184.73.62.175;
    deny 45.115.172.166;
    deny 45.79.93.106;
    deny 113.170.44.74;
    deny 54.72.34.86;
    deny 151.248.0.151;
    deny 112.203.159.24;
    deny 122.175.183.123;
    deny 121.201.14.152;
    deny 36.80.104.239;
    deny 64.251.19.188;
    deny 50.57.149.211;
    deny 187.187.224.166;
    deny 23.253.72.60;
    deny 27.34.20.24;
    deny 104.197.93.224;
    deny 79.131.13.107;
    deny 140.119.55.53;
    deny 106.51.153.39;
    deny 46.253.10.64;
    deny 205.186.146.21;
    deny 162.243.232.75;
    deny 128.199.183.41;
    deny 83.69.74.190;
    deny 2.85.127.85;
    deny 122.174.157.82;
    deny 84.126.101.70;
    deny 201.214.132.9;
    deny 183.82.102.220;
    deny 178.220.16.40;
    deny 5.14.112.113;
    deny 184.169.178.182;
    deny 84.117.139.101;
    deny 105.105.218.22;
    deny 54.252.150.47;
    deny 112.200.192.49;
    deny 162.213.113.59;
    deny 176.74.192.146;
    deny 47.29.69.23;
    deny 185.32.172.84;
    deny 47.31.6.63;
    deny 36.82.212.152;
    deny 122.177.244.242;
    deny 78.131.210.148;
    deny 133.9.192.30;
    deny 112.205.103.75;
    deny 118.67.90.188;
    deny 54.148.87.45;
    deny 54.65.107.1;
    deny 122.167.9.142;
    deny 122.174.187.106;
    deny 130.43.195.112;
    deny 223.206.194.254;
    deny 183.182.111.111;
    deny 54.149.224.207;
    deny 103.252.164.171;
    deny 39.36.0.71;
    deny 86.32.96.115;
    deny 49.35.9.60;
    deny 157.48.20.254;
    deny 119.94.160.49;
    deny 203.134.218.19;
    deny 117.221.204.234;
    deny 176.9.198.122;
    deny 111.68.106.130;
    deny 37.9.210.73;
    deny 110.136.152.5;
    deny 122.117.150.59;
    deny 95.9.86.219;
    deny 23.21.183.99;
    deny 37.157.222.112;
    deny 180.251.10.27;
    deny 47.8.12.47;
    deny 139.194.167.201;
    deny 112.203.118.253;
    deny 191.233.41.135;
    deny 94.254.228.139;
    deny 46.20.154.194;
    deny 202.47.248.149;
    deny 5.188.153.73;
    deny 156.204.221.20;
    deny 110.227.114.70;
    deny 70.32.83.223;
    deny 123.201.66.187;
    deny 47.15.14.186;
    deny 185.120.219.101;
    deny 202.88.246.54;
    deny 52.23.152.76;
    deny 110.36.210.99;
    deny 180.148.212.66;
    deny 134.196.138.229;
    deny 109.73.225.73;
    deny 31.128.184.177;
    deny 103.39.131.242;
    deny 116.102.24.48;
    deny 72.174.97.83;
    deny 125.165.79.156;
    deny 95.90.251.188;
    deny 81.211.103.106;
    deny 139.196.108.41;
    deny 107.170.41.237;
    deny 141.76.38.94;
    deny 116.66.197.148;
    deny 137.135.226.124;
    deny 39.43.100.144;
    deny 185.56.84.218;
    deny 81.169.129.222;
    deny 112.203.174.5;
    deny 54.66.41.68;
    deny 95.213.182.91;
    deny 41.239.84.170;
    deny 117.215.56.100;
    deny 120.29.70.236;
    deny 91.210.204.4;
    deny 119.95.64.113;
    deny 202.83.42.51;
    deny 64.207.146.39;
    deny 202.129.185.79;
    deny 178.153.76.93;
    deny 104.131.204.239;
    deny 182.160.99.89;
    deny 23.97.217.232;
    deny 122.172.252.36;
    deny 130.79.201.203;
    deny 41.238.21.95;
    deny 180.249.100.151;
    deny 50.247.56.27;
    deny 31.209.97.12;
    deny 191.43.39.230;
    deny 161.139.222.7;
    deny 14.235.59.106;
    deny 180.254.220.108;
    deny 54.252.102.12;
    deny 62.80.164.66;
    deny 54.208.65.81;
    deny 178.222.4.64;
    deny 91.139.230.53;
    deny 52.3.4.204;
    deny 27.7.24.23;
    deny 46.107.224.219;
    deny 125.163.56.61;
    deny 104.40.154.67;
    deny 116.58.181.29;
    deny 149.210.169.142;
    deny 70.32.95.52;
    deny 103.234.253.141;
    deny 125.22.83.72;
    deny 188.154.19.43;
    deny 192.244.107.153;
    deny 47.8.9.34;
    deny 103.216.147.42;
    deny 49.207.254.68;
    deny 203.81.91.110;
    deny 104.208.32.246;
    deny 104.239.144.101;
    deny 54.251.108.154;
    deny 171.4.232.182;
    deny 122.174.202.45;
    deny 134.59.229.2;
    deny 176.28.13.163;
    deny 103.46.235.43;
    deny 171.96.224.246;
    deny 39.53.247.223;
    deny 205.186.158.62;
    deny 47.8.12.17;
    deny 103.213.213.71;
    deny 45.121.220.54;
    deny 185.106.31.26;
    deny 54.153.34.195;
    deny 122.53.56.221;
    deny 171.4.129.1;
    deny 217.149.179.101;
    deny 185.34.95.96;
    deny 1.20.133.4;
    deny 219.65.75.246;
    deny 106.201.179.165;
    deny 117.199.161.124;
    deny 175.103.46.126;
    deny 106.51.104.184;
    deny 27.6.170.11;
    deny 103.23.100.153;
    deny 190.5.48.245;
    deny 122.100.231.116;
    deny 182.253.179.195;
    deny 40.74.61.26;
    deny 112.205.218.67;
    deny 1.52.107.107;
    deny 54.149.99.228;
    deny 65.38.77.151;
    deny 41.101.17.93;
    deny 89.237.99.186;
    deny 203.122.251.203;
    deny 123.201.211.158;
    deny 203.189.144.100;
    deny 86.105.127.229;
    deny 104.40.22.161;
    deny 70.32.81.172;
    deny 5.13.215.154;
    deny 23.102.7.115;
    deny 130.105.205.133;
    deny 54.146.27.112;
    deny 182.77.99.231;
    deny 180.191.115.135;
    deny 54.153.115.57;
    deny 192.227.145.168;
    deny 120.29.65.125;
    deny 210.213.69.246;
    deny 117.205.247.130;
    deny 198.61.171.45;
    deny 5.219.182.205;
    deny 104.41.161.169;
    deny 49.148.151.150;
    deny 103.42.85.54;
    deny 47.29.69.83;
    deny 122.144.11.71;
    deny 160.177.58.58;
    deny 134.0.196.10;
    deny 91.250.99.124;
    deny 139.167.10.250;
    deny 191.239.218.221;
    deny 27.62.60.55;
    deny 104.215.94.213;
    deny 36.79.194.202;
    deny 92.85.222.160;
    deny 45.249.122.190;
    deny 180.191.87.121;
    deny 70.32.78.166;
    deny 103.253.112.71;
    deny 64.22.233.27;
    deny 117.200.198.89;
    deny 205.186.149.116;
    deny 39.42.7.136;
    deny 110.169.10.2;
    deny 112.196.133.214;
    deny 92.80.157.81;
    deny 54.187.19.191;
    deny 14.195.234.26;
    deny 49.151.60.2;
    deny 49.145.202.69;
    deny 173.224.211.73;
    deny 54.224.188.60;
    deny 61.155.174.102;
    deny 104.155.57.165;
    deny 42.104.82.146;
    deny 39.37.147.197;
    deny 191.239.6.183;
    deny 117.215.51.162;
    deny 126.242.168.28;
    deny 103.217.241.181;
    deny 70.32.104.126;
    deny 52.5.71.253;
    deny 88.7.12.68;
    deny 106.187.48.141;
    deny 27.145.42.164;
    deny 112.215.171.175;
    deny 64.191.142.246;
    deny 202.138.249.75;
    deny 130.204.73.207;
    deny 5.35.245.192;
    deny 175.41.132.114;
    deny 52.10.245.175;
    deny 112.198.73.147;
    deny 110.169.129.197;
    deny 162.243.140.86;
    deny 157.50.8.160;
    deny 91.223.16.171;
    deny 89.35.44.248;
    deny 122.8.125.184;
    deny 92.114.178.198;
    deny 179.127.252.154;
    deny 192.119.168.147;

    # ignore csp violations
    location /api/v1/csp_violation {
        return 403;
    }

    # proxy traffic for healthcheck to the upstream without https redirect for the ELB to see a 200 on /
    location /.well-known/healthcheck.json {
      limit_req zone=sdc;
      proxy_set_header  Host $host;
      proxy_set_header  X-Real-IP $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header  X-Forwarded-Proto $scheme;
      proxy_ignore_client_abort on;
      proxy_read_timeout 90;
      proxy_http_version 1.1;
      proxy_redirect off;
      proxy_pass  http://steemit-sdc:8080/.well-known/healthcheck.json;
    }

    add_header Strict-Transport-Security "max-age=31557600; includeSubDomains; preload" always;

    location / {
      limit_req zone=sdc burst=50;

      # rewrite http to https (ALB does the https termination)
      if ($http_x_forwarded_proto != 'https') {
        return 301 https://$server_name$request_uri;
      }

      proxy_set_header  Host $host;
      proxy_set_header  X-Real-IP $remote_addr;
      proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header  X-Forwarded-Proto $scheme;
      proxy_ignore_client_abort on;
      proxy_read_timeout 90;
      proxy_http_version 1.1;
      proxy_hide_header Strict-Transport-Security;
      add_header Strict-Transport-Security "max-age=31557600; includeSubDomains; preload" always;
      add_header 'Content-Security-Policy' 'upgrade-insecure-requests';

      proxy_cache sdc_cache;
      proxy_cache_valid 200 2m;
      proxy_cache_key $request_uri;
      proxy_cache_lock on;
      proxy_cache_lock_age 5m;
      proxy_cache_lock_timeout 5m;

      proxy_pass  http://steemit-sdc:8080;

    }
}

server {
    listen 8081;

    server_name www.$SERVER_NAME;
    return 301 https://$SERVER_NAME$request_uri;
}
